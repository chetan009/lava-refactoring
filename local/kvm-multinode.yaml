job_name: kvm-delayed-multinode

# Demonstration and test of delayed_start multinode
# no actual connections made between the two VMs.
# The IP address passed is arbitrary and no attempt is
# made to connect to it.

timeouts:
  job:
    minutes: 10
  action:
    minutes: 2
  test:
    minutes: 3

protocols:
  lava-multinode:
    roles:
      client:
        device_type: qemu
        count: 1
        request: lava-start
        expect_role: server
      server:
        device_type: qemu
        count: 1
    timeout:
      minutes: 6

# multinode use of the context dictionary is going to change.
context:
  arch: amd64

priority: medium
visibility: public

actions:

- deploy:
    role:
    - server
    timeout:
      minutes: 5
    to: tmpfs
    images: 
        rootfs: 
          image_arg: -drive format=raw,file={rootfs}
          url: http://images.validation.linaro.org/kvm-debian-wheezy.img.gz
          compression: gz
    os: debian
    root_partition: 1

- deploy:
    role:
    - client
    timeout:
      minutes: 5
    to: tmpfs
    images:
        rootfs: 
          image_arg: -drive format=raw,file={rootfs}
          url: http://images.validation.linaro.org/kvm-debian-wheezy.img.gz
          compression: gz
    os: debian
    root_partition: 1
    protocols:
      lava-multinode:
        api: lava-wait
        id: ipv4
        key: ipaddr
        timeout:
          minutes: 2

- boot:
    role:
    - server
    - client
    method: qemu
    media: tmpfs
    prompts:
    - "root@debian:"

- test:
    role:
    - client
    name: inline-sync
    definitions:
    - repository:
          metadata:
             format: Lava-Test Test Definition 1.0
             name: client-ssh
             description: "client step"
             os:
                - debian
             scope:
                - functional
          run:
             steps:
                - lava-sync clients
      from: inline
      name: sync-client
      path: inline/sync-client.yaml

- test:
     role:
     - server
     timeout:
       minutes: 5
     definitions:
     - repository:
         metadata:
           format: Lava-Test Test Definition 1.0
           name: test-sync
           description: "test api"
           os:
           - debian
           scope:
           - functional
         run:
           steps:
           - lava-send ipv4 ipaddr=10.15.0.151
           - lava-sync lava_start
           - lava-sync clients
       from: inline
       name: test-sync
       path: inline/test-sync.yaml

- test:
    role:
    - server
    - client
    definitions:
    - repository: http://git.linaro.org/lava-team/lava-functional-tests.git
      from: git
      path: lava-test-shell/multi-node/multinode02.yaml
      name: multinode-intermediate
