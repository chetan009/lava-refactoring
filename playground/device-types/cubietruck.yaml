{% extends 'base.yaml' %}
{% block body %}
device_type: cubietruck

{% set console_device = console_device | default('ttyS0') %}
{% set baud_rate = baud_rate | default(115200) %}


parameters:
  bootz:
    kernel: '{{ bootz_kernel_addr|default('0x42000000') }}'
    ramdisk: '{{ bootz_ramdisk_addr|default('0x43300000') }}'
    dtb: '{{ bootz_dtb_addr|default('0x43000000') }}'
  media:  # two USB slots, only one SATA connector.
    usb:
      UUID-required: True
      {{ usb_label|default('SanDisk_Ultra') }}:
        uuid: {{ usb_uuid }}  # /dev/disk/by-id/
        device_id: {{ usb_device_id|default(0) }}  # the bootloader device id for this media on the 'usb' interface
    sata:
      UUID-required: False
      {{ sata_label|default('ST160LM003') }}:
        uuid: {{ sata_uuid }}
        device_id: {{ sata_id|default(0) }}
        uboot_interface: {{ sata_interface|default('scsi') }}

# requires mainline u-boot, e.g. from Debian:
# https://wiki.debian.org/InstallingDebianOn/Allwinner#U-boot_versions_for_sunxi-based_systems

actions:
  deploy:
    # list of deployment methods which this device supports
    methods:
      usb
      sata
      tftp
  boot:
    # list of boot methods which this device supports.
    methods:
      u-boot:
        parameters:
          bootloader_prompt: {{ bootloader_prompt|default('sun7i') }}
          boot_message: {{ boot_message|default('Booting Linux') }}
          send_char: False
        ramdisk:
          commands:
{{ base_uboot_commands }}
{{ base_uboot_addr_commands }}
{{ base_ftp_commands }}
          - setenv bootargs 'console={{ console_device }},{{ baud_rate }} debug rw root=/dev/ram0 ip=dhcp'
{{ base_uboot_bootcmd }}
        # method specific stanzas
        usb:
          commands:
          - usb start
          - usb info
{{ base_uboot_commands }}
{{ base_uboot_addr_commands }}
          - setenv loadkernel 'load usb {ROOT_PART} ${kernel_addr_r} {KERNEL}'
          - setenv loadinitrd 'load usb {ROOT_PART} ${initrd_addr_r} {RAMDISK}; setenv initrd_size ${filesize}'
          - setenv loadfdt 'load usb {ROOT_PART} ${fdt_addr_r} {DTB}'
          - setenv bootargs 'console={{ console_device }},{{ baud_rate }}n8 root={ROOT} ip=dhcp'
{{ base_uboot_bootcmd }}
        sata:
          commands:
          - scsi scan
          - setenv autoload no
{{ base_uboot_commands }}
{{ base_uboot_addr_commands }}
          - setenv loadkernel 'load scsi {ROOT_PART} ${kernel_addr_r} {KERNEL}'
          - setenv loadinitrd 'load scsi {ROOT_PART} ${initrd_addr_r} {RAMDISK}; setenv initrd_size ${filesize}'
          - setenv loadfdt 'load scsi {ROOT_PART} ${fdt_addr_r} {DTB}'
          - setenv bootargs 'console={{ console_device }},{{ baud_rate }}n8 root={ROOT} ip=dhcp'
{{ base_uboot_bootcmd }}
        nfs:
          commands:
{{ base_uboot_commands }}
{{ base_uboot_addr_commands }}
{{ base_tftp_commands }}
          - "setenv nfsargs 'setenv bootargs console={{ console_device }},{{ baud_rate }}n8 root=/dev/nfs rw {{ base_nfsroot_args }} ip=dhcp'"
{{ base_nfs_uboot_bootcmd }}
{% endblock %}
